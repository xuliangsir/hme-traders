/** * Created by liangxu on 2017/11/21. */let sendVerifyCode = require('../sdk/sendVerifyCode').send_sms;let https = require('https');let qs = require('querystring');let _ = require('lodash');let LoginDao = require('../dao/LoginDao');let ShopDao = require('../dao/ShopDao');let VerifyCode = require('../../controller/sdk/verifyCode');const APIError = require('../../util/rest').APIError;const ErrorCoe = require('../../config/errorCode');const util = require("../../util/util");const qiniu = require("qiniu");const moment = require("moment");class LoginService{    async getVerifyCode(ctx){        const {phone} = ctx.query;        if(!phone){            throw new APIError(1)        }        const userInfo = await new LoginDao().getUserInfoByPhone({phone:phone});        let newuser = false;        if(!!userInfo.length){             newuser = true;            console.log("======phone==========",new Date().getTime() - new Date(userInfo[0].verifytime).getTime(), new Date(userInfo[0].verifytime).getTime());            if((new Date().getTime() - userInfo[0].verifytime) <= 60*1000*5  ){                return false;            }        }            return new Promise((resolve, reject)=>{                //const {phone} = ctx.request.body;                const code = _.random(10001, 100000);                console.log("===getVerifyCode===code===",code);                //verifyCode.sendMsg(mobile, code)                var post_data = {                    'apikey': '9cc160bdb7a4c412734f4798504ce2f1',                    'mobile': phone,                    'text': '【家政圈】您的验证码是' + code                };//这是需要提交的数据                var content = qs.stringify(post_data);                console.log("content========",content);                var options = {                    hostname: 'sms.yunpian.com',                    port: 443,                    path: '/v2/sms/single_send.json',                    method: 'POST',                    headers: {                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'                    }                };                var req = https.request(options, function (res) {                    // console.log('STATUS: ' + res.statusCode);                    // console.log('HEADERS: ' + JSON.stringify(res.headers));                    res.setEncoding('utf8');                    res.on('data', function (chunk) {                        console.log('BODY: ' + chunk, JSON.parse(chunk).code);                        if(JSON.parse(chunk).http_status_code >0 ){                            console.error("yunpian request error chunk: ",JSON.parse(chunk).http_status_code);                            return reject(JSON.parse(chunk).http_status_code)                        }                        if(JSON.parse(chunk).code == 0){                            if(!newuser){                                const params = {                                    uuid: util.getUserUUID(),                                    nickname: "",                                    phone: phone,                                    password: "123456",                                    verifyCode: code                                };                                try{                                    new LoginDao().addRestifyCode(params);                                } catch(e){                                    reject(false);                                }                            }else{                                try{                                    new LoginDao().updateRestifyCodeByPhone({phone: phone, verifyCode: code});                                } catch(e){                                    reject(false) ;                                }                            }                        }                    });                });                req.on('error', (e) => {                    console.error("yunpian request error==",e);                    req.end();                    return reject(false) ;                });                req.write(content);                req.end();                resolve({result:"OK",verifycode: code});            })    }    async regist(ctx) {        const {phone, verifyCode} = ctx.request.body;        console.log("=====regist=====",phone, verifyCode);        const result = await new LoginDao().getUserInfoByPhoneAndVerifyCode({phone: phone, verifyCode: verifyCode});        const updateResult = await new LoginDao().updateRegtime({phone: phone});        console.log("===regist==result=====", result);        if(!result.length){            return false;        }        result[0].isSetupPassword = false;        result[0].shopid = 0;        return result[0];     }    async mobileRegist(ctx) {        const {phone, verifyCode, password} = ctx.request.body;        console.log("=====regist=====",phone, verifyCode, password);        const result = await new LoginDao().getUserInfoByPhoneAndVerifyCode({phone: phone, verifyCode: verifyCode});        const updateResult = await new LoginDao().mobileRpdateRegtime({phone: phone, password: password});        console.log("===regist==result=====", result);        if(!result.length){            return false;        }        result[0].shopid = 0;        return {userInfo: result[0], isSetupPassword: false};    }     async setupPwd(ctx){         const {phone, password} = ctx.request.body;         if (!phone || !password) {             throw new APIError(1);         }         console.log("==setupPwd==phonephone=======", phone);         const userInfo = await new LoginDao().getUserInfoByPhone({phone: phone});         console.log("==setupPwd==userInfo=======", userInfo);         if (!userInfo.length) {             return 1002;         }         const result = await new LoginDao().setupPassword({phone: phone, password: password});         console.log("==setupPwd==result=======", result);         if (result == 0) {             return false;         }         return true;     }    async reSetupPwd(ctx){        const {phone, password} = ctx.request.body;        console.log("==resetupPwd==userInfo000=======",phone, password);        const userInfo = await new LoginDao().getUserInfoByPhone({phone: phone});        console.log("==resetupPwd==userInfo000=======",userInfo[0]);        if(!userInfo.length){            throw new APIError(1002);        }        const result = await new LoginDao().setupPassword({phone: phone,  password: password});        console.log("======resetupPwd==result11111=======",result);        return result;    }    async login(ctx){        const {phone, password} = ctx.request.body;        console.log("=====login===password==", phone, password);        if (!phone || !password) {            throw new APIError(1);        }        const userinfo = await new LoginDao().getUserInfoByPhoneAndPassword({phone: phone, password: password});        if (!userinfo.length) {            return false;        }        if (!!userinfo.length) {            const shopInfo = await new LoginDao().getShopSetupInfoDao({userid: userinfo[0].userid});            if (!!shopInfo.length) {                userinfo[0].shopid = shopInfo[0].shopid;            }            let isSetupPassword = false;            if (!!userinfo[0].password) {                isSetupPassword = true;            }            console.log("=====login===userinfo==", userinfo);            return {userInfo: userinfo[0], isSetupPassword: isSetupPassword};        }    }    async addShopsetupService(ctx){        const {userid, phone,name,album,orderattention,shopintro,servicemobile,servicetimebegin,               servicetimeend,week,servicerange,minorderlimit,attachcost,exemptattachcost, appointmenttime,               shoptype, lat, lon, serviceaddress, radius} = ctx.request.body;        // if(!name || !shopintro || !servicemobile || !servicetimebegin || !servicetimeend ){        //     throw new APIError(1)        // }        const params = {            userid: userid,            phone: phone,            name: name,            album: JSON.stringify(album),            orderattention: orderattention || 0,            shopintro :shopintro,            servicemobile: servicemobile,            servicetimebegin: servicetimebegin || util.getCurrentDate(),            servicetimeend: servicetimeend || util.getCurrentDate(),            minorderlimit: minorderlimit|| 0,            attachcost: attachcost || 0,            exemptattachcost: exemptattachcost|| 0,            appointmenttime: appointmenttime,            shoptype:shoptype || 0,            lat:lat || 0,            lon:lon || 0,            serviceaddress:serviceaddress || "",            radius:radius || 0        };        if(!!ctx.request.body.week){            params.week= JSON.stringify(ctx.request.body.week);        }else{            params.week= "";        }        if(!!ctx.request.body.servicerange){            params.servicerange= JSON.stringify(ctx.request.body.servicerange);        }else{            params.servicerange= "";        }        console.log("===addShopsetupService==params=====",params);        let shopInfo = await new LoginDao().getShopSetupInfoDao(params);        let result=0;        if(!!shopInfo.length){              result = await new LoginDao().updateShopsetupDao(params);        }else{              result = await new LoginDao().addShopsetupDao(params);              shopInfo = await new LoginDao().getShopSetupInfoDao(params);        }        console.log("===shopInfoshopInfoshopInfoshopInfo=====",shopInfo);        return {shopid: shopInfo[0].shopid};    }    async getShopSetupInfoService(ctx){        const {userid} = ctx.query;        console.log("===getShopSetupInfoService==userid===",userid);        const result = await new LoginDao().getShopSetupInfoDao({userid:userid});        _.each(result, function(item){            if(!!item.album){                item.album = JSON.parse(item.album);            }            if(!!item.week){                item.week = JSON.parse(item.week);            }            if(!!item.servicerange){                item.servicerange = JSON.parse(item.servicerange);            }        });        console.log("===getShopSetupInfo==result=====",result);        if(!result.length){            return false;        }        return result[0];    }    async updateShopsetupService(ctx){        const {userid, phone, name, album, orderattention, shopintro, servicemobile, servicetimebegin, servicetimeend, week, servicerange, minorderlimit,attachcost,exemptattachcost,appointmenttime} = ctx.request.body;        if(!name || !shopintro || !servicemobile || !servicetimebegin || !servicetimeend ){            throw new APIError(1)        }        const params = {            userid: userid,            phone: phone,            name: name,            album: JSON.stringify(album),            orderattention: orderattention,            shopintro : shopintro,            servicemobile: servicemobile,            servicetimebegin: servicetimebegin,            servicetimeend:  servicetimeend,            servicerange: JSON.stringify(servicerange),            minorderlimit: minorderlimit,            attachcost: attachcost,            exemptattachcost: exemptattachcost,            appointmenttime: appointmenttime        };        if(!!params.week){            week: JSON.stringify(week)        }        const result = await new LoginDao().addShopsetupDao(params);        console.log("===shopsetup==result=====",result);        if(!result){            return false;        }        return true;    }    async addShopcertifyService(ctx){        const {userid, phone,licencename,type,licenceurl,creditcode,licenceregnum,registaddress,licencelocation,legalentity,limittimebegin,limittimeend,identitycardphoto,name,identitycardnum} = ctx.request.body;        // if(!name || !shopintro || !servicemobile || !servicetimebegin || !servicetimeend ){        //     throw new APIError(1)        // }        const params = {            userid: userid,            phone: phone,            licencename: licencename,            type: type,            licenceurl: JSON.stringify(licenceurl),            creditcode :creditcode,            licenceregnum: licenceregnum,            registaddress: registaddress,            licencelocation: licencelocation,            legalentity: legalentity,            limittimebegin: limittimebegin || util.getCurrentDate(),            limittimeend: limittimeend || util.getCurrentDate(),            name: name,            identitycardnum: identitycardnum,            identitycardphoto: JSON.stringify(identitycardphoto)        };        const certResult = await new LoginDao().getShopCertifyInfoDao({userid:userid});        let isAdd = 0;        if(!!certResult.length){            isAdd = await new LoginDao().updateShopCertifyInfoDao(params);        }else{            isAdd = await new LoginDao().addShopCertifyDao(params);        }        console.log("===addShopcertifyService==isAdd=====",isAdd);        if(isAdd > 0){            return true;        }        return true;    }    async getShopCertifyInfoService(ctx){        const {userid} = ctx.query;        if(!userid){            throw new APIError()        }        const result = await new LoginDao().getShopCertifyInfoDao({userid:userid});        console.log("===getShopCertifyInfoService==result=====",result);        _.each(result, function(item){            if(item.licenceurl){                item.licenceurl = JSON.parse(item.licenceurl);            }            if(item.identitycardphoto){                item.identitycardphoto = JSON.parse(item.identitycardphoto);            }        });        if(!result.length){            return false;        }        return result[0];    }    async getqiniutoken(ctx){        qiniu.conf.ACCESS_KEY = '3EaWN0DRyn_4gZxB2wFFH7W0vdxluf0ZZO6TZLvr';        qiniu.conf.SECRET_KEY = 'PQVBDF-TUGelOwHZrOMOiPUeH3WR0ESaL0yQchkl';        var mac = new qiniu.auth.digest.Mac(accessKey, secretKey);        var myUptoken = new qiniu.rs.PutPolicy("home");        var token = myUptoken.token();                console.log("=====tokentoken======",token);        moment.locale('en');        var currentKey = moment(new Date()).format('YYYY-MM-DD--HH-mm-ss');           }    async getShopServiceList(ctx){        const {userid, shopid} = ctx.query;        if(!userid || !shopid){            throw new APIError(1);        }        const result = await new ShopDao().getShopServiceListDao(shopid);        console.log("======getShopServiceList======result===",result);        let serviceList =[];        _.each(result, function(item){            let serviceInfo = {};            serviceInfo.serviceid = item.serviceid;            serviceInfo.name = item.name;            serviceInfo.serviceDesc = item.description;            if(!!item.serviceimgurl){                serviceInfo.serviceimgurl = JSON.parse(item.serviceimgurl);            }else{                serviceInfo.serviceimgurl = "";            }            serviceInfo.originalprice = item.price + item.unit;            serviceInfo.price = item.price + item.unit;            let cityArray = JSON.parse(item.city);            let city="";            _.each(cityArray, function(item){                city+=item +" "            });            serviceInfo.city = city;            serviceList.push(serviceInfo);        });        return serviceList;    }    async getShopServiceListMobile(ctx){        const {userid, shopid} = ctx.query;        if(!userid || !shopid){            throw new APIError(1);        }        const result = await new ShopDao().getShopServiceListDao(shopid);        console.log("======getShopServiceList==mobile====result===",result);        let serviceList =[];        _.each(result, function(item){            let serviceInfo = {};            serviceInfo.serviceid = item.serviceid;            serviceInfo.name = item.name;            serviceInfo.serviceDesc = item.description;            if(!!item.serviceimgurl){                serviceInfo.serviceimgurl =  JSON.parse(item.serviceimgurl);            }else{                serviceInfo.serviceimgurl = "";            }            serviceInfo.originalprice = item.originalprice;            serviceInfo.price = item.price;            serviceInfo.unit = item.unit;            let cityArray = JSON.parse(item.city);            let city="";            _.each(cityArray, function(item){                city+=item +" "            });            serviceInfo.city = city;            serviceList.push(serviceInfo);        });        console.log("======serviceList==mobile====serviceList===",serviceList);        return serviceList;    }    async modPassword(ctx){        const {userid, password} = ctx.request.body;        if(!userid || !password){            return Promise.resolve();        }        const params = {};        if(!_.isEmpty(userid)) params.userid= userid;        if(!_.isEmpty(password)) params.password = password;        try{            return await new LoginDao().updateuUserPwdByUserid(params);        }catch(e){            throw e;        }    }}module.exports = LoginService;